<!-- Copyright FUJITSU LIMITED 2015-->
<project default="testBillingPlugin">
  <import file="../macros/marketplace/all.xml" />

  <target name="testBillingPlugin">
	
  	<webtest name="testBillingPlugin - setup visibility">
  	  <operatorPortal.login />
  	  <clickLink href="/operator/manageConfiguration.jsf" />
  	  <storeXPath property="hiddenElementFieldId" xpath="//td[text()='HIDDEN_UI_ELEMENTS']/..//input/@id" propertyType="ant" />
  	  <storeXPath property="hiddenElementFieldValue" xpath="//td[text()='HIDDEN_UI_ELEMENTS']/..//input/@value" propertyType="ant" />
  	  <setInputField htmlId="${hiddenElementFieldId}" value="" />
      <clickElement htmlId="configurationSettings:saveButton" />
  	  <common.verifySuccess label="${info.configuration.saved}" />
      <login.logout />
  	</webtest>	
  	
    <webtest name="testBillingPlugin - Bug 11886 - Inner Chart Navigation on Table View">
      <operatorPortal.login />
      <clickLink href="/operator/manageBillingAdapters.jsf" />
      <common.ignorePageScriptError />
      <clickButton label="Add" />
      <verifyElementText htmlId="panels:1:panelAdapterItemForm:labeladapterId" text="Billing system ID" />
      <login.logout />
    </webtest>
    
    <webtest name="testBillingPlugin - Bug 11916">
      <operatorPortal.login />
      <clickLink href="/operator/manageBillingAdapters.jsf" />
      <common.ignorePageScriptError />
      <clickButton label="Add" />
      <verifyElementText htmlId="panels:1:panelAdapterItemForm:labeladapterName" text="Short description" />
      <login.logout />
    </webtest>
    
    <webtest name="testBillingPlugin - Bug 11885 - Operation/Manage billing systems Add button can be pressed multiple times">
      <operatorPortal.login />
      <clickLink href="/operator/manageBillingAdapters.jsf" />
      <common.ignorePageScriptError />
      <clickButton label="Add" />
      <verifyXPath xpath="//*[contains(@id, 'addButtonDisabled')]" />
      <login.logout />
    </webtest>
    
    <webtest name="testBillingPlugin - Bug 11883 - Operation/Manage billing systems fields not verified">
      <operatorPortal.login />
      <clickLink href="/operator/manageBillingAdapters.jsf" />
      <common.ignorePageScriptError />
      <clickButton label="Add" />
      <dataDriven tableContainer="data/pageFields/manageBillingAdapters.xls">
        <storeProperty name="fieldId" value="${fieldId}" propertyType="dynamic" />
        <storeProperty name="fieldType" value="${fieldType}" propertyType="dynamic" />
        <storeProperty name="required" value="${required}" propertyType="dynamic" />
        <ifStep description="Test if required" test="#{required}">
          <common.testFieldValidation fieldId="#{fieldId}" fieldValue="" error="${javax.faces.component.UIInput.REQUIRED}"
                                      buttonLinkId="panels:1:panelAdapterItemForm:saveButton"/>
        </ifStep>
        <dataDriven tableContainer="data/invalidInput/#{fieldType}.xls">
          <common.initializeDataDrivenErrorMessage errormsg="${errormsg}" att0="${att0}" />
          <common.testFieldValidation fieldId="#{fieldId}" fieldValue="${value}" error="${expectedMessage}"
                                      buttonLinkId="panels:1:panelAdapterItemForm:saveButton" />
        </dataDriven>
      </dataDriven>
      <login.logout />
    </webtest>
    
    <webtest name="testBillingPlugin - Bug 11902 - Set as Default button not working">
      <operatorPortal.login />
      <clickLink href="/operator/manageBillingAdapters.jsf" />
      <common.ignorePageScriptError />
      <clickButton label="Add" />
      <setInputField name="panels:1:panelAdapterItemForm:adapterId" value="Test service" />
      <setInputField name="panels:1:panelAdapterItemForm:adapterName" value="Test service" />
      <clickButton label="Save"/>
      <clickLink htmlId="panels:1:panelAdapterItemForm:setDefaultButton"/>
      <verifyXPath xpath="//*[text()[contains(.,'Test service (Default)')]]"/>
      <clickLink htmlId="panels:0:panelAdapterItemForm:setDefaultButton"/>
      <clickLink htmlId="panels:1:panelAdapterItemForm:deleteButton"/>
      <verifyXPath xpath="//*[text()[contains(.,'NATIVE_BILLING')]]"/>
     </webtest> 
    
    <webtest name="testBillingPlugin - Bug 11912 - Operation/Manage billing systems, connection properties - does not remove empty line">
      <operatorPortal.login />
      <clickLink href="/operator/manageBillingAdapters.jsf" />
      <common.ignorePageScriptError />
      <!-- Try to add a new billing adapter -->
      <clickButton label="Add" />
      <setInputField name="panels:1:panelAdapterItemForm:adapterId" value="Test service" />
      <setInputField name="panels:1:panelAdapterItemForm:adapterName" value="Test service" />
      <setInputField xpath="//input[starts-with(@name,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]" value="Test connection1" />
      <!-- Try to add  a second connection property -->
      <clickElement xpath="//input[starts-with(@id,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]" />
      <setInputField xpath="//*[@id='panels:1:panelAdapterItemForm:connectionPropertiesTable:1:connectionProperty']" value="Second property" />
      <setInputField xpath="//input[starts-with(@name,'panels:1:panelAdapterItemForm:connectionPropertiesTable:1:j_')]" value="Test connection2" />
      <!-- Add third connection property -->
      <clickElement xpath="//input[starts-with(@id,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]" />
      <verifyXPath xpath="//*[@value='Test connection1']"/>
      <verifyXPath xpath="//*[@value='Second property']"/>
      <verifyXPath xpath="//*[@value='Test connection2']"/>
      <!-- Remove the second property -->
      <clickElement xpath="//input[starts-with(@id,'panels:1:panelAdapterItemForm:connectionPropertiesTable:1:j_')]" />
      <verifyXPath xpath="//*[not(@value='Second property')]"/>
      <verifyXPath xpath="//*[not(@value='Test connection2')]"/>
     </webtest>
    
    <webtest name="testBillingPlugin - Bug 11919 - Technical service/View billing systems ':' missing after labels">
      <mail.cleanInbox />
      <operator.createorganization />
      <mail.readPasswordAndUrlFromMail />
      <login.initialLoginAndChangePassword url="#{orgUrl}" userId="#{userId}" password="#{userPwd}" />
      <clickLink href="/techservice/viewBillingAdapters.jsf" />
      <verifyXPath xpath="//*[text()[contains(.,'Billing system ID:')]]"/>
      <verifyXPath xpath="//*[text()[contains(.,'Short description:')]]"/>
    </webtest> 
  	
  	<webtest name="testBillingPlugin - setup adapter">
	  <operatorPortal.login />
	  <clickLink href="/operator/manageBillingAdapters.jsf" />
	  <common.ignorePageScriptError />
	  <clickButton label="Add" />
	  <setInputField name="panels:1:panelAdapterItemForm:adapterId"
		value="FileBilling" />
	  <setInputField name="panels:1:panelAdapterItemForm:adapterName"
		value="File Billing" />
	  <setInputField
		xpath="//input[starts-with(@name,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]"
		value="java:global/oscm-file-adapter/oscm-file-adapter" />

	  <!-- Add a org.omg.CORBA.ORBInitialPort -->
	  <clickElement
		xpath="//input[starts-with(@id,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]" />
	  <setInputField
		xpath="//*[@id='panels:1:panelAdapterItemForm:connectionPropertiesTable:1:connectionProperty']"
		value="org.omg.CORBA.ORBInitialPort" />
	  <setInputField
		xpath="//input[starts-with(@name,'panels:1:panelAdapterItemForm:connectionPropertiesTable:1:j_')]"
		value="8637" />

	  <!-- Add a org.omg.CORBA.ORBInitialHost -->
	  <clickElement
		xpath="//input[starts-with(@id,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]" />
	  <setInputField
		xpath="//*[@id='panels:1:panelAdapterItemForm:connectionPropertiesTable:2:connectionProperty']"
		value="org.omg.CORBA.ORBInitialHost" />
	  <setInputField
		xpath="//input[starts-with(@name,'panels:1:panelAdapterItemForm:connectionPropertiesTable:2:j_')]"
		value="localhost" />

	  <!-- java.naming.provider.url -->
	  <clickElement
		xpath="//input[starts-with(@id,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]" />
	  <setInputField
		xpath="//*[@id='panels:1:panelAdapterItemForm:connectionPropertiesTable:3:connectionProperty']"
		value="java.naming.provider.url" />
	  <setInputField
		xpath="//input[starts-with(@name,'panels:1:panelAdapterItemForm:connectionPropertiesTable:3:j_')]"
		value="http://localhost:8680" />

	  <!-- java.naming.factory.initial -->
	  <clickElement
		xpath="//input[starts-with(@id,'panels:1:panelAdapterItemForm:connectionPropertiesTable:0:j_')]" />
	  <setInputField
		xpath="//*[@id='panels:1:panelAdapterItemForm:connectionPropertiesTable:4:connectionProperty']"
		value="java.naming.factory.initial" />
	  <setInputField
		xpath="//input[starts-with(@name,'panels:1:panelAdapterItemForm:connectionPropertiesTable:4:j_')]"
		value="com.sun.enterprise.naming.SerialInitContextFactory" />
	
	  <clickButton label="Save" />
    </webtest>
  	
  	<webtest name="testBillingPlugin - verifyExternalPriceModel">
	  <mail.cleanInbox />
	  <operator.addCurrency />
	  <operator.createorganization />
	  <mail.readPasswordAndUrlFromMail />
	  <storeProperty name="supplierUrl" value="#{orgUrl}" propertyType="ant" />
	  <storeProperty name="supplierId" value="#{orgId}" propertyType="ant" />
	  <storeProperty name="supplierUserId" value="#{userId}" propertyType="ant" />
	  <storeProperty name="supplierUserKey" value="#{userKey}" propertyType="ant" />
	
	  <operator.createMarketplace mIdProperty="mId" ownerId="#{orgId}" baseurl="#{baseUrl}" name="Ext Marketplace" failonerror="true"/>
	
	  <login.initialLoginAndChangePassword url="#{orgUrl}" userId="#{userId}" password="#{userPwd}" />

	  <techservice.import file="data/TechnicalServiceExternalBilling.xml" />
	
	  <storeProperty name="techServiceId" value="MockService with external billing" />
	  <storeProperty name="marketServiceName" value="Market Service with external billing" propertyType="dynamic" />
	
	  <service.define marketplaceId="${mId}" serviceId="#{marketServiceName}" techServiceId="#{techServiceId}" />
	
	  <common.clickAndVerfyLink label="${priceModel.service.title}" />
	
	  <verifyXPath xpath="//a[@id='editForm:uploadExternalPriceModelButton']" />
      <verifyXPath xpath="//a[@id='editForm:hiddenDisplayExternalPriceModelButton']" />
	
    </webtest>
    
  	<webtest name="testBillingPlugin - cleanup">
  	  <operatorPortal.login />
  	  <clickLink href="/operator/manageConfiguration.jsf" />
  	  <setInputField htmlId="${hiddenElementFieldId}" value="${hiddenElementFieldValue}" />
      <clickElement htmlId="configurationSettings:saveButton" />
  	  <common.verifySuccess label="${info.configuration.saved}" />
      <login.logout />
  	</webtest>
  	
  </target>

</project>
